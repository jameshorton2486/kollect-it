# AI API Route Safety Rules

## üö® CRITICAL BUILD SAFETY REQUIREMENTS

When working with ANY AI-related code:

### ‚ùå NEVER DO
- Instantiate OpenAI or any AI SDK at module scope
- Access process.env.OPENAI_API_KEY or process.env.CLAUDE_API_KEY outside a request handler
- Perform AI calls during Next.js build time
- Import AI SDKs at the top level of API routes

### ‚úÖ ALWAYS DO

1. **Add at the top of every AI API route:**
```ts
export const dynamic = "force-dynamic";
```

2. **Load AI clients lazily inside request handlers using the shared helper:**
```ts
import { getOpenAIClient } from "@/lib/ai/client";
// or
import { getAnthropicClient } from "@/lib/ai/client";

export async function POST(req: Request) {
  try {
    const client = await getOpenAIClient();
    // Use client here
  } catch (err) {
    return Response.json(
      { error: "AI service unavailable" },
      { status: 500 }
    );
  }
}
```

3. **Handle missing API keys gracefully** with a 500 response (the helper throws, catch it)

## üìÅ Applies to:

- `src/app/api/**/ai*`
- `src/app/api/**/analyze*`
- `src/app/api/**/generate*`
- `src/lib/ai/**`

## ‚ùó Enforcement

If Cursor detects:
- `new OpenAI(...)` outside a function
- `new Anthropic(...)` outside a function
- `process.env.OPENAI_API_KEY` at module scope
- `process.env.CLAUDE_API_KEY` at module scope

It MUST stop and refactor to use the shared client helper from `@/lib/ai/client`.

**Failure to follow these rules WILL break Vercel builds.**
