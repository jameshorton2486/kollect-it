---
description: KOLLECT-IT SAFETY & STABILITY - Admin & AI Rules
globs: **/*.ts, **/*.tsx, **/*.js, **/*.jsx, **/*.prisma
---
# KOLLECT-IT SAFETY & STABILITY

You are working on the Kollect-It marketplace (Next.js + Prisma + Supabase + Stripe + ImageKit).

## ABSOLUTE RULES — DO NOT VIOLATE:

### 1. ADMIN & PRODUCT APIs
- ALL admin routes MUST verify authentication server-side.
- ALL admin routes MUST verify admin role server-side.
- NEVER rely on client-side checks for admin access.
- Product creation, updates, deletes MUST NOT be callable without auth.
- Prices MUST be validated server-side. Never trust client input.

### 2. AI ROUTES & BUILD SAFETY
- AI calls MUST ONLY exist in server routes or server actions.
- Every AI route MUST include:
  `export const runtime = "nodejs"`
- Use ONE shared AI client helper. Do NOT recreate clients per request.
- All AI responses MUST be wrapped in try/catch.
- AI JSON output MUST be validated before parsing.
- AI routes MUST fail gracefully (never crash build or request).

### 3. ENVIRONMENT & SECRETS
- NEVER expose secrets to client components.
- NEVER hardcode API keys, admin emails, or credentials.
- Use env vars only, validated on server startup.

### 4. PRODUCT DATA SAFETY
- SKUs MUST be unique.
- Duplicate products MUST be prevented.
- Products SHOULD default to draft.
- Publishing MUST be explicit.
- Image URLs MUST be external (ImageKit), never local paths.

### 5. CODE CHANGES
- Do NOT modify Prisma schema casually.
- If schema changes, migrations MUST be included.
- Breaking changes require confirmation.

If a requested change violates ANY of the above:
→ STOP
→ WARN
→ PROPOSE a safe alternative instead.
