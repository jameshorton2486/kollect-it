#!/bin/sh
set -e

echo "ğŸ” Kollect-It pre-commit checks..."

# Block root-level markdown (except README.md)
ROOT_MD=$(git diff --cached --name-only | grep -E '^[^/]+\.md$' | grep -v '^README\.md$' || true)
if [ -n "$ROOT_MD" ]; then
  echo "âŒ ERROR: Root-level markdown files are not allowed."
  echo "$ROOT_MD"
  echo "Please move these files to /docs or remove them."
  exit 1
fi

# Block scratch / temp files (but allow legitimate template JSON files)
SCRATCH=$(git diff --cached --name-only | grep -E '(scratch|draft|notes|temp|_notes|_draft|_scratch)' | grep -v 'work_files/' | grep -v 'product-application/desktop-app/templates/.*\.json$' || true)
if [ -n "$SCRATCH" ]; then
  echo "âŒ ERROR: Scratch or draft files detected."
  echo "$SCRATCH"
  echo "Please remove these files or move them to work_files/ if needed."
  exit 1
fi

# Block commented-out code (simple heuristic)
COMMENTED=$(git diff --cached | grep -E '^\+.*(//|/\*)' | grep -iE '(todo|remove|temp|delete|deprecated)' | head -5 || true)
if [ -n "$COMMENTED" ]; then
  echo "âš ï¸  WARNING: Possible commented-out or temporary code detected."
  echo "$COMMENTED"
  echo "Please review and remove commented code before committing."
fi

# Existing repo safety check
FORBIDDEN_PATTERNS=".next/ .idea/ .venv/ .vercel/ node_modules/"
for pattern in $FORBIDDEN_PATTERNS; do
  if git diff --cached --name-only | grep -q "^$pattern" 2>/dev/null; then
    echo "âŒ ERROR: Files in $pattern must not be committed"
    exit 1
  fi
done

echo "âœ… Kollect-It repo checks passed."
