Codex Prompt: Fix Database Authentication Error
Problem
The create-admin.ts script fails with:
Error querying the database: FATAL: SASL authentication failed
This means the DATABASE_URL password in Vercel does not match the actual Supabase database password.

Task 1: Create a Database Connection Diagnostic Script
Create scripts/diagnose-db-connection.ts:
typescriptimport 'dotenv/config';
import { config } from 'dotenv';

// Load .env then .env.local (same order as Next.js)
config({ path: '.env' });
config({ path: '.env.local', override: true });

/**
 * Database Connection Diagnostic Script
 * 
 * Tests the DATABASE_URL connection and provides helpful debugging info
 * without exposing the actual password.
 */

async function main() {
  console.log("üîç Database Connection Diagnostic\n");
  console.log("=".repeat(50));

  // 1. Check if DATABASE_URL exists
  const dbUrl = process.env.DATABASE_URL;
  if (!dbUrl) {
    console.error("‚ùå DATABASE_URL is not set!");
    console.log("\nüí° Fix: Run 'vercel env pull .env.local --environment=production'");
    process.exit(1);
  }

  // 2. Parse and display URL components (mask password)
  try {
    const url = new URL(dbUrl);
    console.log("\nüìä DATABASE_URL Components:");
    console.log(`   Protocol: ${url.protocol}`);
    console.log(`   Host:     ${url.hostname}`);
    console.log(`   Port:     ${url.port || '5432 (default)'}`);
    console.log(`   Database: ${url.pathname.slice(1)}`);
    console.log(`   Username: ${url.username}`);
    console.log(`   Password: ${url.password ? '***' + url.password.slice(-4) + ` (${url.password.length} chars)` : '‚ùå EMPTY!'}`);
    console.log(`   Params:   ${url.search || '(none)'}`);

    // Check for common issues
    console.log("\nüîé Connection Analysis:");
    
    if (!url.password) {
      console.log("   ‚ùå Password is EMPTY - this will cause auth failure");
    } else if (url.password.length < 10) {
      console.log("   ‚ö†Ô∏è  Password seems short - verify it's correct");
    } else {
      console.log("   ‚úÖ Password is present");
    }

    if (url.hostname.includes('pooler.supabase.com')) {
      console.log("   ‚úÖ Using Supabase connection pooler (recommended)");
    } else if (url.hostname.includes('supabase.co')) {
      console.log("   ‚ö†Ô∏è  Using direct Supabase connection (pooler recommended for serverless)");
    }

    if (url.port === '6543') {
      console.log("   ‚úÖ Port 6543 (PgBouncer transaction mode)");
    } else if (url.port === '5432') {
      console.log("   ‚ÑπÔ∏è  Port 5432 (direct connection)");
    }

  } catch (e) {
    console.error("‚ùå DATABASE_URL is not a valid URL format");
    console.log(`   Raw value starts with: ${dbUrl.substring(0, 30)}...`);
    process.exit(1);
  }

  // 3. Attempt connection
  console.log("\nüîå Testing Connection...");
  
  try {
    const { PrismaClient } = await import('@prisma/client');
    const prisma = new PrismaClient({
      log: ['error'],
    });

    await prisma.$queryRaw`SELECT 1 as test`;
    console.log("   ‚úÖ Connection successful!");
    
    // Quick table check
    const userCount = await prisma.user.count();
    console.log(`   ‚úÖ Users table accessible (${userCount} users found)`);
    
    await prisma.$disconnect();
    console.log("\n‚úÖ Database is working correctly!\n");
    
  } catch (error: any) {
    console.log("   ‚ùå Connection FAILED\n");
    
    if (error.message?.includes('SASL authentication failed')) {
      console.log("üî¥ DIAGNOSIS: Password mismatch");
      console.log("\n" + "=".repeat(50));
      console.log("FIX: The password in DATABASE_URL doesn't match Supabase.\n");
      console.log("MANUAL STEPS REQUIRED:");
      console.log("‚îÄ".repeat(50));
      console.log("1. Go to: https://supabase.com/dashboard");
      console.log("2. Select your Kollect-It project");
      console.log("3. Go to: Settings ‚Üí Database");
      console.log("4. Under 'Connection string' section, click 'Reset database password'");
      console.log("5. Copy the NEW password");
      console.log("6. Run in PowerShell:");
      console.log("");
      console.log("   vercel env rm DATABASE_URL production");
      console.log("   vercel env rm DIRECT_URL production");
      console.log("");
      console.log("7. Then add them back with the NEW password:");
      console.log("");
      console.log("   vercel env add DATABASE_URL production");
      console.log("   # Paste: postgresql://postgres.[PROJECT_REF]:[NEW_PASSWORD]@aws-0-us-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true");
      console.log("");
      console.log("   vercel env add DIRECT_URL production");  
      console.log("   # Paste: postgresql://postgres.[PROJECT_REF]:[NEW_PASSWORD]@aws-0-us-east-1.pooler.supabase.com:5432/postgres");
      console.log("");
      console.log("8. Pull fresh env vars:");
      console.log("   vercel env pull .env.local --environment=production");
      console.log("");
      console.log("9. Run this diagnostic again to verify:");
      console.log("   npx tsx scripts/diagnose-db-connection.ts");
      console.log("‚îÄ".repeat(50));
      
    } else if (error.message?.includes('connection refused')) {
      console.log("üî¥ DIAGNOSIS: Cannot reach database server");
      console.log("   Check if Supabase project is active/not paused");
      
    } else if (error.message?.includes('does not exist')) {
      console.log("üî¥ DIAGNOSIS: Database or user doesn't exist");
      console.log("   Check the database name and username in the URL");
      
    } else {
      console.log("üî¥ DIAGNOSIS: Unknown error");
      console.log(`   Error: ${error.message}`);
    }
    
    process.exit(1);
  }
}

main();

Task 2: Update scripts/create-admin.ts to show better errors
At the top of the main() function, add a pre-flight check:
typescriptasync function main() {
  console.log("üîê Creating admin user...\n");
  
  // Pre-flight: Check DATABASE_URL
  if (!process.env.DATABASE_URL) {
    console.error("‚ùå DATABASE_URL is not set!");
    console.log("   Run: vercel env pull .env.local --environment=production");
    process.exit(1);
  }
  
  console.log("‚ö†Ô∏è  SECURITY: This script requires secure credentials\n");
  // ... rest of existing code
}
And update the catch block to provide better guidance:
typescript} catch (error: any) {
  if (error.message?.includes('SASL authentication failed')) {
    console.error("‚ùå Database authentication failed!");
    console.log("\nüí° The DATABASE_URL password is incorrect.");
    console.log("   Run: npx tsx scripts/diagnose-db-connection.ts");
    console.log("   for detailed fix instructions.\n");
  } else {
    console.error("‚ùå Error creating admin user:", error);
  }
  process.exit(1);
}

Files Created/Modified
FileActionscripts/diagnose-db-connection.tsNEW ‚Äî Connection diagnostic with fix instructionsscripts/create-admin.tsAdd pre-flight check and better error messages

After Codex Completes ‚Äî Manual Steps for James
The code changes create better diagnostics, but the actual fix requires manual steps:
Step 1: Run the diagnostic
powershellnpx tsx scripts/diagnose-db-connection.ts
Step 2: Reset Supabase password

Go to https://supabase.com/dashboard
Select your Kollect-It project
Navigate to Settings ‚Üí Database
Click Reset database password
COPY THE NEW PASSWORD IMMEDIATELY (shown only once!)

Step 3: Get the full connection strings from Supabase
In the same Database settings page:

Find "Connection string" section
Select "URI" format
Copy the Transaction pooler string (port 6543) ‚Üí this is DATABASE_URL
Copy the Session pooler string (port 5432) ‚Üí this is DIRECT_URL
Replace [YOUR-PASSWORD] placeholder with your actual new password

Step 4: Update Vercel
powershell# Remove old values
vercel env rm DATABASE_URL production
vercel env rm DIRECT_URL production

# Add new values (paste when prompted)
vercel env add DATABASE_URL production
# Paste the transaction pooler URL with real password

vercel env add DIRECT_URL production
# Paste the session pooler URL with real password
Step 5: Pull and test
powershellvercel env pull .env.local --environment=production
npx tsx scripts/diagnose-db-connection.ts
Step 6: Create admin user
powershell$env:ADMIN_EMAIL="info@kollect-it.com"; npx tsx scripts/create-admin.ts

Root Cause
The Supabase database password was likely:

Rotated/changed in Supabase dashboard
Never correctly set in Vercel after initial setup
Copied incorrectly (missing characters, URL encoding issues)

The diagnostic script will confirm the exact issue.